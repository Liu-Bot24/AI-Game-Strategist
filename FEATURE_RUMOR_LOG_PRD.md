### 产品需求文档(PRD): “风闻记录”功能模块

**版本**: 2.0 (Final)
**日期**: 2025-09-22

#### 1. 功能概述 (Feature Overview)

为弥补单纯截图无法完整还原游戏事件和对话流的短板，本项目将新增一个名为“风闻记录”的核心功能模块。该模块利用现有语音转文字（STT）功能，允许玩家录制游戏中的完整对话场景。通过为录音补充必要的上下文信息（如发言人、场景属性等），并调用大语言模型（LLM）进行智能分析和整理，最终生成结构化的、易于回顾的事件记录。这些记录将被存储在专属的`风闻.md`文件中，并能作为核心数据源，为“抉择辅助”模块提供更深层次的历史事件参考，从而显著提升AI军师的分析质量和决策建议的准确性。

#### 2. 需求详述 (Detailed Requirements)

##### 2.1. 新增 “风闻记录” 标签页

在主窗口的标签页序列中，新增一个名为“风闻记录”的标签页，建议放置在“速记与整理台”和“抉择辅助”之间。

*   **UI布局 (从上至下)**:
    1.  **语音转录文本框**: 一个`QTextEdit`，用于接收和显示语音实时转录的游戏对话原文。语音功能开启时，识别的文字应能自动插入此文本框。
    2.  **场景信息配置区**:
        *   **发言人选择**: 水平排列5个`QComboBox`，标签分别为“发言人1”至“发言人5”。
            *   **数据源**: 动态加载所有角色档案名。
            *   **特殊选项**: 必须额外包含`旁白`、`不明`、`无`三个固定选项。
            *   **样式**: 宽度需自适应，确保能完整显示所有角色名。
        *   **场景属性**: 两个`QCheckBox`，选项为`主角参与`和`偷听`。
    3.  **AI整理按钮**: 一个`QPushButton`，文本为“🤖 AI整理场景”。
    4.  **AI分析结果框**: 一个只读的`QTextEdit`，用于显示LLM整理后的场景摘要。该文本框需能随主窗口大小自适应调整高度。
    5.  **记录按钮**: 一个`QPushButton`，文本为“📋 记录到风闻”，点击后将AI分析结果追加保存到`风闻.md`文件。

*   **技术实现建议**:
    *   在`main.py`的`init_ui`中新增`create_rumor_log_tab()`方法，其内部实现可大量参考`create_quick_notes_tab()`来创建和布局UI控件。
    *   **修改`main.py`中的`load_character_list()`方法**，在其中增加逻辑，将角色列表和特殊选项一并填充到这5个新的`QComboBox`中，确保数据源统一，自动同步。
    *   语音输入功能无需额外开发，现有的`insert_text_to_focused_widget`机制可直接复用。

##### 2.2. 核心逻辑与Prompt工程

1.  **“AI整理场景”按钮核心逻辑**:
    *   **触发**: 用户点击后，触发`run_rumor_analysis()`方法。
    *   **数据收集**: 获取转录原文、5个发言人选项、2个场景属性状态。
    *   **数据校验**: 确保转录文本不为空，且至少选择了一位发言人（非“无”）。
    *   **档案读取**: 根据选择的发言人角色，读取`characters`目录下对应的`.md`档案。
    *   **Prompt构建**: 调用`build_rumor_prompt()`方法，将所有信息填充到下述模板中。
    *   **API调用**: 异步调用`api_service.py`中的`send_chat_request`函数。
    *   **结果展示**: 将API返回的分析结果显示在“AI分析结果框”中。

2.  **Prompt模板 (风闻记录)**:
    ```prompt
    # 身份与任务
    你是一位专业的剧情分析师和速记员。你的任务是根据我提供的【原始对话文本】、【场景关键信息】以及相关的【角色背景档案】，还原并整理出一段完整的游戏场景记录。你需要清晰地梳理出在场人员、谁说了什么，并总结事件的核心内容。
    **重要提醒**: 【原始对话文本】来自语音识别，可能包含少量错别字或不通顺与断句不合理之处。请结合【角色背景档案】和上下文，智能理解以及合理断句，并修正这些小瑕疵，还原出最合理的对话内容。

    ---
    ## 第一部分：原始对话文本 (来自语音识别)
    {transcript_text}

    ---
    ## 第二部分：场景关键信息
    *   **在场人员**: {speaker_list}
    *   **场景属性**: {scene_attributes}

    ---
    ## 第三部分：相关角色背景档案
    {character_dossiers}

    ---
    ## 第四部分：你的整理任务
    请严格按照以下格式，生成一份结构化的场景记录：

    1.  **【场景总结】**: 用一句话高度概括这个场景发生了什么事。
    2.  **【参与人员】**: 列出所有参与该场景的角色。
    3.  **【对话还原】**:
        *   根据对话文本和你的推理，以“角色名：『对话内容』”的格式，尽可能还原对话。
        *   注意，仔细思考和断句，根据语义和称谓等，辨别每一句话的说话人，避免错误的说话人归属。
        *   对于“旁白”或“不明”身份的发言，也请照常记录。
    4.  **【情景分析】**: 结合场景属性（主角是否参与/偷听）和角色档案，简要分析对话中可能存在的潜台词、人物情绪或重要信息点。
    ```

3.  **“记录到风闻”按钮逻辑**:
    *   读取“AI分析结果框”中的内容，在开头追加格式为`## 记录时间: YYYY-MM-DD HH:MM:SS\n\n`的时间戳，然后将完整内容追加写入到项目根目录下的`风闻.md`文件。

*   **技术实现建议**:
    *   `run_rumor_analysis()`方法的实现应**完全模仿`get_decision_advice()`**，使用`ChatWorker` (`QThread`)进行异步处理，避免UI卡顿，并连接`chat_completed`和`chat_failed`信号来更新UI。
    *   在`MainWindow.__init__`中定义`self.RUMOR_LOG_FILE = "风闻.md"`，方便全局调用。

##### 2.3. “抉择辅助” 标签页功能增强

1.  **UI变更**:
    *   在“参考所有角色档案”`QCheckBox`下方，新增一个`QCheckBox`，文本为“参考风闻记录”。

2.  **逻辑变更**:
    *   当用户在勾选此项后点击“获取抉择建议”，程序需额外读取`风闻.md`文件的全部内容，并将其作为新的数据源传入`build_decision_prompt`函数。

3.  **Prompt模板更新 (游戏抉择建议)**:
    ```prompt
    # 身份与任务
    ... (原有内容) ...
    ---
    ## 第一部分：当前游戏画面情景分析
    ... (原有内容) ...
    ---
    ## 第二部分：关键人物背景档案
    ... (原有内容) ...
    ---
    ## 第三部分：风闻记录 (历史事件回顾)
    这是我通过旁听或亲身经历记录下来的、过去发生的关键事件。这些记录对于理解当前人物关系和局势至关重要。
    {rumor_log_content}
    ---
    ## 第四部分：我的补充说明
    {additional_context_text}
    ---
    ## 第五部分：你的分析任务
    ... (原有内容) ...
    ```

*   **技术实现建议**:
    *   在`get_decision_advice`方法内部，增加一段逻辑：如果`self.include_rumors_checkbox`被勾选，则读取`self.RUMOR_LOG_FILE`文件。
    *   修改`build_decision_prompt`的函数签名，增加一个新参数`rumor_content: str`，并在`prompt_template.format()`时使用它。

##### 2.4. “角色档案” 标签页功能增强

1.  **UI变更**:
    *   在“选择角色”的`QComboBox`旁边，新增一个`QPushButton`，文本为“查看风闻记录”。

2.  **交互逻辑**:
    *   **点击“查看风闻记录”**: 档案内容框 (`dossier_text_edit`) 切换为显示`风闻.md`的全部内容并设为只读；“选择角色”下拉框、“创建新角色”和“保存修改”按钮均被禁用；该按钮自身文本变为“返回角色档案”。
    *   **点击“返回角色档案”**: 恢复所有控件的可用状态和`QTextEdit`的可编辑状态；按钮文本恢复；`QTextEdit`重新加载当前所选角色的档案。

*   **技术实现建议**:
    *   在`MainWindow`中增加一个布尔状态位 `self.is_viewing_rumors = False`。
    *   创建一个`toggle_rumor_view()`方法来处理按钮点击事件。该方法根据`self.is_viewing_rumors`的值来切换UI控件的启用/禁用状态、文本内容，并加载不同的文本数据。切换回角色视图时，直接调用`self.on_character_changed(self.character_combo.currentText())`即可复用现有逻辑刷新界面。

#### 3. 开发路线图建议

1.  **第一阶段：UI实现**: 在`main.py`中完成所有三个标签页的UI控件新增与布局。
2.  **第二阶段：核心功能逻辑**: 实现“风闻记录”标签页的完整后台逻辑，包括AI整理和文件写入。
3.  **第三阶段：功能集成与联动**: 实现“抉择辅助”和“角色档案”与`风闻.md`的数据联动和视图切换。
4.  **第四阶段：联调测试与优化**: 对整个新功能链路进行完整测试，修复Bug，优化体验。

#### 4. 验收标准 (Acceptance Criteria)

*   [ ] 应用启动后，新增的“风闻记录”标签页及其所有UI控件均正常显示。
*   [ ] 在“风闻记录”页，语音输入能将文字填入上方文本框，发言人下拉框能正确加载所有角色和特殊选项。
*   [ ] 点击“AI整理场景”按钮后，能成功调用LLM并返回结构化的场景摘要到下方的文本框。
*   [ ] 点击“记录到风闻”按钮后，`风闻.md`文件被创建或更新，内容包含时间戳和AI摘要。
*   [ ] 在“抉择辅助”页，勾选“参考风闻记录”后，AI的分析建议能体现出对历史事件的参考。
*   [ ] 在“角色档案”页，能通过按钮在“查看风闻记录”和“查看角色档案”两种视图间正常切换，且控件状态符合预期。
